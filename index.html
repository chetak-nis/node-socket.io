<html>
  <head>
    <title>NIS-io</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <p id='server-time'></p>
    <p id='gyroscope'>Gyro not available</p>
    <p id='direction'>Direction not available</p>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var el = document.getElementById('server-time');

      socket.on('alert', function(timeString) {
       el.innerHTML = 'Alert: ' + timeString;
      });
    </script>
    <button class="btn btn-default" id="askButton">Ask for location</button>
    <div id="target"></div>
    <script>
      var target = document.getElementById('target');
      var watchId;

      function appendLocation(location, verb) {
        verb = verb || 'updated';
        var newLocation = document.createElement('p');
        newLocation.innerHTML = 'Location ' + verb+ 'on'+ Date().toString() + ' with direction ' + location.coords.heading + ' speed ' + location.coords.speed  + ' Accuracy ' + location.coords.accuracy   + ': <a href="https://maps.google.com/maps?&z=15&q=' + location.coords.latitude + '+' + location.coords.longitude + '&ll=' + location.coords.latitude + '+' + location.coords.longitude + '" target="_blank">' + location.coords.latitude + ', ' + location.coords.longitude + '</a>';
        target.appendChild(newLocation);
      }

      if ('geolocation' in navigator) {
        document.getElementById('askButton').addEventListener('click', function () {
          navigator.geolocation.getCurrentPosition(function (location) {
            appendLocation(location, 'fetched');
          });
          watchId = navigator.geolocation.watchPosition(appendLocation);
        });
      } else {
        target.innerText = 'Geolocation API not supported.';
      }
      // Gyroscope
      if (typeof Gyroscope === "function") {
      let gyroscope = new Gyroscope({frequency: 60});
      gyroscope.addEventListener('reading', e => {
        var el = document.getElementById('gyroscope');
        el.innerHTML ="Angular velocety along the X-axis " + gyroscope.x + " Y-axis " + gyroscope.y+ " Z-axis " + gyroscope.z ;
      });
      gyroscope.start();
      }
      //Direction
      function compassHeading(alpha, beta, gamma) {

        // Convert degrees to radians
        var alphaRad = alpha * (Math.PI / 180);
        var betaRad = beta * (Math.PI / 180);
        var gammaRad = gamma * (Math.PI / 180);

        // Calculate equation components
        var cA = Math.cos(alphaRad);
        var sA = Math.sin(alphaRad);
        var cB = Math.cos(betaRad);
        var sB = Math.sin(betaRad);
        var cG = Math.cos(gammaRad);
        var sG = Math.sin(gammaRad);

        // Calculate A, B, C rotation components
        var rA = - cA * sG - sA * sB * cG;
        var rB = - sA * sG + cA * sB * cG;
        var rC = - cB * cG;

        // Calculate compass heading
        var compassHeading = Math.atan(rA / rB);

        // Convert from half unit circle to whole unit circle
        if(rB < 0) {
          compassHeading += Math.PI;
        }else if(rA < 0) {
          compassHeading += 2 * Math.PI;
        }

        // Convert radians to degrees
        compassHeading *= 180 / Math.PI;

        return compassHeading;

      }

      window.addEventListener('deviceorientation', function(evt) {

        var heading = null;

        if(evt.absolute === true && evt.alpha !== null) {
          heading = compassHeading(evt.alpha, evt.beta, evt.gamma);
        }
          var el = document.getElementById('direction');
          el.innerHTML ="Direction In degreess " + heading ;
        // Do something with 'heading'...

      }, false);
    </script>
  </body>
</html>
